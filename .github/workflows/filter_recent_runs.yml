name: Clean Old Workflow Runs and Artifacts

on:
  schedule:
    - cron: '0 * * * *'  # Every hour, at minute 0

jobs:
  clean-up:
    runs-on: ubuntu-latest

    steps:
    - name: Delete workflow runs and artifacts older than one hour
      run: |
        echo "‚öôÔ∏è Starting cleanup job..."

        CURRENT_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        TWO_HOUR_AGO=$(date -u -d '2 hour ago' +"%Y-%m-%dT%H:%M:%SZ")
        API_URL="https://api.github.com/repos/${{ github.repository }}"
        TOKEN=${{ secrets.GITHUB_TOKEN }}

        # ---------------------------
        # 1Ô∏è‚É£ Delete workflow runs
        # ---------------------------
        echo "üóëÔ∏è Deleting workflow runs older than $TWO_HOUR_AGO"

        RUNS=$(curl -s -H "Authorization: Bearer $TOKEN" "$API_URL/actions/runs")

        echo "$RUNS" | jq -c --arg TWO_HOUR_AGO "$TWO_HOUR_AGO" '.workflow_runs[] | select(.created_at < $TWO_HOUR_AGO)' | while read -r run; do
          ID=$(echo "$run" | jq -r '.id')
          CREATED=$(echo "$run" | jq -r '.created_at')
          echo "‚Üí Deleting run ID: $ID (created at: $CREATED)"
          curl -X DELETE -H "Authorization: Bearer $TOKEN" "$API_URL/actions/runs/$ID"
        done

        # ---------------------------
        # 2Ô∏è‚É£ Delete old artifacts
        # ---------------------------
        echo "üßπ Cleaning up old artifacts..."

        ARTIFACTS=$(curl -s -H "Authorization: Bearer $TOKEN" "$API_URL/actions/artifacts")

        echo "$ARTIFACTS" | jq -c --arg TWO_HOUR_AGO "$TWO_HOUR_AGO" '.artifacts[] | select(.created_at < $TWO_HOUR_AGO)' | while read -r artifact; do
          ART_ID=$(echo "$artifact" | jq -r '.id')
          ART_NAME=$(echo "$artifact" | jq -r '.name')
          CREATED=$(echo "$artifact" | jq -r '.created_at')
          echo "‚Üí Deleting artifact: $ART_NAME (ID: $ART_ID, created at: $CREATED)"
          curl -X DELETE -H "Authorization: Bearer $TOKEN" "$API_URL/actions/artifacts/$ART_ID"
        done

        echo "‚úÖ Cleanup complete."


